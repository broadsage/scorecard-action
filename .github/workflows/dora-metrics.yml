name: DORA Metrics Collection

on:
  schedule:
    - cron: '0 6 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  pull-requests: read

jobs:
  dora-metrics:
    name: Collect DORA Metrics
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Debug Repository Context
        run: |
          echo "üîç Repository Debug Information"
          echo "github.repository: ${{ github.repository }}"
          echo "github.repository_owner: ${{ github.repository_owner }}"
          echo "Expected format: owner/repo"
          
      - name: DevOps Metrics from GitHub
        id: dora  
        uses: stenjo/devops-metrics-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repo: broadsage/scorecard-action
        continue-on-error: true
          
      - name: Display Results  
        if: always()
        run: |
          echo "üìä DORA Metrics Collection"
          echo "========================="
          if [[ "${{ steps.dora.outcome }}" == "success" ]]; then
            echo "‚úÖ DORA metrics collection completed successfully"
            echo "üìà Check the action logs above for detailed metrics"
            echo "üîç Metrics include: Deploy Frequency, Lead Time, Change Failure Rate, and MTTR"
            echo ""
            echo "üìã Using industry-standard marketplace action: stenjo/devops-metrics-action@v1"
            echo "üìä Metrics are calculated based on releases, PRs, and issue data"
          else
            echo "‚ö†Ô∏è Metrics collection encountered issues"
            echo "üîß Possible reasons:"
            echo "   - Repository format issue (fixed: hardcoded broadsage/scorecard-action)"
            echo "   - Repository may not have enough historical data"
            echo "   - Insufficient releases, issues, or pull requests" 
            echo "   - Network or API rate limiting issues"
            echo "   - Action may have bugs with repository parsing"
            echo ""
            echo "ÔøΩ Troubleshooting steps applied:"
            echo "   - Hardcoded repository name to avoid parsing issues"
            echo "   - Added debug output for repository context"
            echo "   - Used continue-on-error to prevent workflow failure"
            echo ""
            echo "ÔøΩüîß To improve metrics accuracy:"
            echo "   - Ensure regular releases are created" 
            echo "   - Use issues to track bugs and incidents"
            echo "   - Maintain consistent PR workflow"
            echo "   - Consider alternative DORA metrics solutions if issues persist"
          fi
