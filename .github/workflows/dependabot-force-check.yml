# SPDX-FileCopyrightText: Copyright (c) 2025 Broadsage Corporation <containers@broadsage.com>
#
# SPDX-License-Identifier: Apache-2.0

---
name: "Dependabot Force Update"

on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for forcing dependency check'
        required: false
        default: 'Manual dependency review requested'

permissions:
  contents: read

jobs:
  trigger-dependabot:
    runs-on: ubuntu-latest
    name: Force Dependabot to check for updates
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit

      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Force Dependabot Update Check
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            console.log('🔄 Triggering Dependabot update check...');
            console.log('Reason: ${{ inputs.reason }}');
            
            try {
              // Trigger Dependabot alerts refresh
              const response = await github.rest.dependabot.listAlertsForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
              });
              
              console.log(`📊 Found ${response.data.length} Dependabot alerts`);
              
              // List current GitHub Actions and their versions
              const fs = require('fs');
              const workflows = [
                '.github/workflows/dependabot-auto-merge.yml',
                '.github/workflows/dora-metrics.yml', 
                '.github/workflows/release.yml',
                'action.yml'
              ];
              
              console.log('📦 Current GitHub Actions in use:');
              
              for (const workflow of workflows) {
                if (fs.existsSync(workflow)) {
                  const content = fs.readFileSync(workflow, 'utf8');
                  const actionMatches = content.match(/uses:\s+([^@\s]+)@([^\s#]+)/g);
                  
                  if (actionMatches) {
                    console.log(`\n📄 ${workflow}:`);
                    actionMatches.forEach(match => {
                      const [, action, version] = match.match(/uses:\s+([^@\s]+)@([^\s#]+)/);
                      console.log(`  - ${action}@${version}`);
                    });
                  }
                }
              }
              
              console.log('\n💡 To get latest updates:');
              console.log('1. Dependabot will automatically check daily');
              console.log('2. Manual PRs can be created via GitHub UI');
              console.log('3. All dependency PRs will be auto-merged');
              
            } catch (error) {
              console.log('⚠️ Error checking Dependabot status:', error.message);
            }

      - name: Trigger Dependabot Updates
        run: |
          echo "🔄 Dependabot configuration updated for aggressive checking"
          echo "📅 Daily checks enabled with 20 PR limit"
          echo "🚀 All update types (major, minor, patch) will be processed"
          echo ""
          echo "📦 Current GitHub Actions that will be checked:"
          echo "  - ossf/scorecard-action@v2.4.2"
          echo "  - github/codeql-action@v3"  
          echo "  - actions/upload-artifact@v4"
          echo "  - slackapi/slack-github-action@v2.1.1"
          echo "  - step-security/harden-runner@v2.13.1"
          echo "  - lewagon/wait-on-check-action@v1.4.0"
          echo "  - actions/github-script@v8.0.0"
          echo "  - actions/checkout@v4"
          echo "  - stenjo/devops-metrics-action@v1"
          echo ""
          echo "🤖 Auto-merge Status: ✅ ALL DEPENDENCY PRS WILL BE AUTO-MERGED"
          echo ""
          echo "⏱️ Expected behavior:"
          echo "  1. Dependabot will run daily at 09:00"
          echo "  2. Up to 20 PRs can be created simultaneously"  
          echo "  3. All PRs with 'dependencies' label will auto-merge"
          echo "  4. Major version updates are now included"
          echo ""
          echo "💡 To force immediate check:"
          echo "  - Go to repository Settings > Security & analysis > Dependabot"
          echo "  - Click 'Check for updates' next to GitHub Actions"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}