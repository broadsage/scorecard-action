name: Release with GoReleaser

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version type to release'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
          - prerelease
      dry_run:
        description: 'Run in dry-run mode (no actual release)'
        required: false
        type: boolean
        default: false
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write
  packages: write
  id-token: write
  attestations: write

jobs:
  release:
    name: GoReleaser Release
    runs-on: ubuntu-latest
    outputs:
      release_version: ${{ steps.version.outputs.version }}
      release_url: ${{ steps.goreleaser.outputs.release_url }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Calculate Version (Manual Trigger)
        id: version
        if: github.event_name == 'workflow_dispatch'
        run: |
          # Get latest version tag
          LATEST_TAG=$(git tag -l "v*" --sort=-version:refname | head -1)
          if [[ -z "$LATEST_TAG" ]]; then
            LATEST_TAG="v0.0.0"
          fi
          
          # Extract version numbers
          if [[ $LATEST_TAG =~ v([0-9]+)\.([0-9]+)\.([0-9]+) ]]; then
            MAJOR=${BASH_REMATCH[1]}
            MINOR=${BASH_REMATCH[2]}
            PATCH=${BASH_REMATCH[3]}
          else
            MAJOR=0
            MINOR=0
            PATCH=0
          fi
          
          # Calculate new version based on input
          VERSION_TYPE="${{ inputs.version_type }}"
          case $VERSION_TYPE in
            major)
              NEW_VERSION="v$((MAJOR + 1)).0.0"
              ;;
            minor)
              NEW_VERSION="v${MAJOR}.$((MINOR + 1)).0"
              ;;
            patch)
              NEW_VERSION="v${MAJOR}.${MINOR}.$((PATCH + 1))"
              ;;
            prerelease)
              NEW_VERSION="v${MAJOR}.${MINOR}.${PATCH}-rc.$(date +%Y%m%d%H%M%S)"
              ;;
          esac
          
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "previous_version=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "üì¶ Version: $LATEST_TAG ‚Üí $NEW_VERSION ($VERSION_TYPE)"
          
          # Create tag if not dry run
          if [[ "${{ inputs.dry_run }}" != "true" ]]; then
            git tag "$NEW_VERSION"
            git push origin "$NEW_VERSION"
          fi

      - name: Extract Version from Tag (Push Trigger)
        id: tag_version
        if: github.event_name == 'push'
        run: |
          NEW_VERSION=${GITHUB_REF#refs/tags/}
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Tagged Release: $NEW_VERSION"

      - name: Validate Action
        run: |
          echo "üîç Validating GitHub Action configuration..."
          
          # Basic YAML syntax validation
          if ! python3 -c "import yaml; yaml.safe_load(open('action.yml'))"; then
            echo "‚ùå action.yml has invalid YAML syntax"
            exit 1
          fi
          
          # Check required action fields
          if ! yq eval '.name' action.yml >/dev/null 2>&1; then
            echo "‚ùå action.yml missing 'name' field"
            exit 1
          fi
          
          if ! yq eval '.description' action.yml >/dev/null 2>&1; then
            echo "‚ùå action.yml missing 'description' field"
            exit 1
          fi
          
          if ! yq eval '.runs' action.yml >/dev/null 2>&1; then
            echo "‚ùå action.yml missing 'runs' field"
            exit 1
          fi
          
          echo "‚úÖ Action validation passed"

      - name: Set up Go
        uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6.0.0
        with:
          go-version: '1.21'

      - name: Install Cosign
        uses: sigstore/cosign-installer@d7543c93d881b35a8faa02e8e3605f69b7a1ce62 # v3.10.0
        with:
          cosign-release: 'v2.4.1'

      - name: Run GoReleaser (Dry Run)
        if: inputs.dry_run == true
        uses: goreleaser/goreleaser-action@e435ccd777264be153ace6237001ef4d979d3a7a # v6.1.0
        with:
          distribution: goreleaser
          version: '~> v2'
          args: release --snapshot --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run GoReleaser (Release)
        if: inputs.dry_run != true
        id: goreleaser
        uses: goreleaser/goreleaser-action@e435ccd777264be153ace6237001ef4d979d3a7a # v6.1.0
        with:
          distribution: goreleaser
          version: '~> v2'
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COSIGN_EXPERIMENTAL: 1

      - name: Generate Job Summary
        if: always()
        run: |
          echo "## üöÄ Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ inputs.dry_run }}" == "true" ]]; then
            echo "**Mode:** üß™ Dry Run (no actual release created)" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Mode:** üéØ Production Release" >> $GITHUB_STEP_SUMMARY
          fi
          
          VERSION="${{ steps.version.outputs.version || steps.tag_version.outputs.version }}"
          echo "**Version:** $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ steps.goreleaser.outcome }}" == "success" ]]; then
            echo "**Status:** ‚úÖ Success" >> $GITHUB_STEP_SUMMARY
            if [[ -n "${{ steps.goreleaser.outputs.release_url }}" ]]; then
              echo "**Release URL:** ${{ steps.goreleaser.outputs.release_url }}" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "**Status:** ‚ùå Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Usage" >> $GITHUB_STEP_SUMMARY
          echo "Update your workflows to use the new version:" >> $GITHUB_STEP_SUMMARY
          echo '```yaml' >> $GITHUB_STEP_SUMMARY
          echo "uses: broadsage/scorecard-action@$VERSION" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Update Major Version Tag
        if: inputs.dry_run != true && (github.event_name == 'workflow_dispatch' || github.event_name == 'push')
        run: |
          VERSION="${{ steps.version.outputs.version || steps.tag_version.outputs.version }}"
          
          # Extract major version (e.g., v1.2.3 -> v1)
          if [[ $VERSION =~ ^v([0-9]+)\. ]]; then
            MAJOR_VERSION="v${BASH_REMATCH[1]}"
            
            echo "üìå Updating major version tag: $MAJOR_VERSION -> $VERSION"
            
            # Force update major version tag
            git tag -f "$MAJOR_VERSION" "$VERSION"
            git push origin "$MAJOR_VERSION" --force
            
            echo "‚úÖ Major version tag updated: $MAJOR_VERSION"
          else
            echo "‚ö†Ô∏è Could not extract major version from $VERSION"
          fi

  # Notify on completion
  notify:
    name: Notify Release
    needs: release
    runs-on: ubuntu-latest
    if: always() && needs.release.outputs.release_version != ''
    steps:
      - name: Notify Success
        if: needs.release.result == 'success'
        run: |
          echo "üéâ Successfully released ${{ needs.release.outputs.release_version }}"
          echo "üîó Release URL: ${{ needs.release.outputs.release_url }}"
          
      - name: Notify Failure
        if: needs.release.result == 'failure'
        run: |
          echo "‚ùå Release failed for ${{ needs.release.outputs.release_version }}"
          exit 1