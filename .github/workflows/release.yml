name: Release

on:
  push:
    branches: [main]

permissions:
  contents: write
  packages: write
  id-token: write
  attestations: write

jobs:
  semantic-release:
    name: Release & Publish
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit

      - name: Checkout Code
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}  # Use standard token temporarily

      - name: Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: '20'

      - name: Install Dependencies
        run: npm ci

      - name: Import GPG key for verified commits/tags
        uses: crazy-max/ghaction-import-gpg@e89d40939c28e39f97cf32126055eeae86ba74ec # v6.3.0
        with:
          gpg_private_key: ${{ secrets.AUTOBOT_GITHUB_GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.AUTOBOT_GITHUB_GPG_PASSPHRASE }}
          fingerprint: ${{ secrets.AUTOBOT_GITHUB_GPG_FINGERPRINT }}
          git_user_signingkey: true
          git_commit_gpgsign: true
          git_tag_gpgsign: true
          git_config_global: true
          git_committer_name: broadsage-autobot
          git_committer_email: broadsage-autobot@broadsage.com

      - name: Verify Action Configuration
        run: |
          echo "üîç Validating GitHub Action configuration..."
          
          # Basic YAML syntax validation  
          if command -v yq >/dev/null 2>&1; then
            yq eval '.' action.yml >/dev/null || { echo "‚ùå action.yml has invalid YAML syntax"; exit 1; }
          fi
          
          # Verify GPG setup
          echo "üîê Verifying GPG configuration..."
          gpg --list-secret-keys --keyid-format LONG || echo "‚ö†Ô∏è No GPG keys found"
          git config --global user.signingkey || echo "‚ö†Ô∏è No signing key configured"
          
          echo "‚úÖ Action configuration is valid"

      - name: Create Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GIT_AUTHOR_NAME: broadsage-autobot
          GIT_AUTHOR_EMAIL: broadsage-autobot@broadsage.com
          GIT_COMMITTER_NAME: broadsage-autobot
          GIT_COMMITTER_EMAIL: broadsage-autobot@broadsage.com
        run: |
          echo "üöÄ Running semantic-release for GitHub Action..."
          echo "üìù Using committer: $(git config --global user.name) <$(git config --global user.email)>"
          
          # Use hybrid approach: disable local git GPG signing but keep GPG setup for manual operations
          # This prevents semantic-release from hanging while keeping GPG available
          git config --global commit.gpgsign false
          git config --global tag.gpgsign false
          
          # Verify GPG is available but not actively used by git
          echo "üîê GPG Status:"
          gpg --list-secret-keys --keyid-format LONG && echo "‚úÖ GPG keys available" || echo "‚ö†Ô∏è No GPG keys found"
          echo "üîë Git signing disabled for semantic-release compatibility"
          
          npm run semantic-release

      - name: Sign Released Tag (Post-Release)
        if: success()
        env:
          GPG_PASSPHRASE: ${{ secrets.AUTOBOT_GITHUB_GPG_PASSPHRASE }}
        run: |
          # Get the latest tag created by semantic-release
          LATEST_TAG=$(git tag --sort=-version:refname | head -n1)
          
          if [ -n "$LATEST_TAG" ] && [ "$LATEST_TAG" != "" ]; then
            echo "üè∑Ô∏è Found new tag: $LATEST_TAG"
            
            # Configure GPG for signing
            export GPG_TTY=$(tty)
            echo "allow-loopback-pinentry" >> ~/.gnupg/gpg-agent.conf
            echo "pinentry-mode loopback" >> ~/.gnupg/gpg.conf  
            gpgconf --reload gpg-agent
            
            # Sign the tag
            echo "üîê Signing tag $LATEST_TAG..."
            git tag --force --sign "$LATEST_TAG" -m "Release $LATEST_TAG" && echo "‚úÖ Tag signed successfully" || echo "‚ö†Ô∏è Tag signing failed"
            
            # Push the signed tag
            git push --force origin "$LATEST_TAG" && echo "‚úÖ Signed tag pushed" || echo "‚ö†Ô∏è Failed to push signed tag"
          else
            echo "‚ÑπÔ∏è No new tag found to sign"
          fi

      - name: Generate Release Summary
        if: always()
        run: |
          echo "## üöÄ Semantic Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status == 'success' && '‚úÖ Success' || '‚ùå Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "### üì¶ Latest Release" >> $GITHUB_STEP_SUMMARY
            echo "Check the [releases page](https://github.com/${{ github.repository }}/releases) for the latest version." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üìã Usage" >> $GITHUB_STEP_SUMMARY
            echo '```yaml' >> $GITHUB_STEP_SUMMARY
            echo "uses: ${{ github.repository }}@v{version}" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi