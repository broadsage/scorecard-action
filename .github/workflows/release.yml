name: Auto-Release on Dependabot Updates

on:
  pull_request:
    types: [closed]
    branches: [main]

env:
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  auto-release:
    if: github.event.pull_request.merged == true && github.event.pull_request.user.login == 'dependabot[bot]'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Release Environment
        run: |
          chmod +x .github/scripts/release.py
          echo "âœ… Release utilities ready"

      - name: Process Dependency Update and Create Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 .github/scripts/release.py "${{ github.event.pull_request.title }}"
          
      - name: Release Summary
        if: success()
        run: |
          LATEST_RELEASE=$(git tag -l "v*" --sort=-version:refname | head -1)
          cat << EOF >> $GITHUB_STEP_SUMMARY
          ## ğŸ‰ Auto-Release Complete
          
          **âœ… Successfully created release:** $LATEST_RELEASE
          **ğŸ“‹ PR Processed:** ${{ github.event.pull_request.title }}
          **ğŸ“‹ Upstream notes:** Successfully fetched and included
          
          ### ğŸ”— Quick Links
          - [ğŸ“‹ View Release](https://github.com/${{ github.repository }}/releases/tag/$LATEST_RELEASE)
          - [ğŸ  Repository](https://github.com/${{ github.repository }})
          
          ### ğŸš€ Next Steps  
          The release is now live and ready for use. Update your workflows with:
          \`\`\`yaml
          uses: broadsage/scorecard-action@v1
          \`\`\`
          EOF
          echo "ğŸ¯ Release workflow completed successfully!"
